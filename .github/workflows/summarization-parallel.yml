name: Run summmarization-parallel
env:
    WATSONX_KEY: ${{secrets.WATSONX_KEY}}
    WATSONX_PROJECT_ID: ${{secrets.WATSONX_PROJECT_ID}}
    WATSONX_URL: ${{secrets.WATSONX_URL}}
on:
  workflow_dispatch:

permissions:
  pull-requests: write
  contents: write
  repository-projects: write
  packages: write

jobs:
  run-script:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        index: [0, 39, 79, 119, 159, 199, 239, 279, 319, 359, 399, 439, 479, 519, 559, 599, 639, 679, 719, 759, 799, 839, 879, 919, 959, 999, 1039, 1079, 1119, 1159, 1199, 1239, 1279, 1319, 1359, 1399, 1439, 1479, 1519, 1559, 1599, 1639, 1679, 1719, 1759, 1799, 1839, 1879, 1919, 1959, 1999, 2039, 2079, 2119, 2159, 2199, 2239, 2279, 2319, 2359, 2399, 2439, 2479, 2519, 2559, 2599, 2639, 2679, 2719, 2759, 2799, 2839, 2879, 2919, 2959, 2999, 3039, 3079, 3119, 3159, 3199, 3239, 3279, 3319, 3359, 3399, 3439, 3479, 3519, 3559, 3599, 3639, 3679, 3719, 3759, 3799, 3839, 3879, 3919, 3959, 3999, 4039, 4079, 4119, 4159, 4199, 4239, 4279, 4319, 4359, 4399, 4439, 4479, 4519, 4559, 4599, 4639, 4679, 4719, 4759, 4799, 4839, 4879, 4919, 4959, 4999, 5039, 5079, 5119, 5159, 5199, 5239, 5279, 5319, 5359, 5399, 5439, 5479, 5519, 5559, 5599, 5639, 5679, 5719, 5759, 5799, 5839, 5879, 5919, 5959, 5999, 6039, 6079, 6119, 6159, 6199, 6239, 6279, 6319, 6359, 6399, 6439, 6479, 6519, 6559, 6599, 6639, 6679, 6719, 6759, 6799, 6839, 6879, 6919, 6959, 6999, 7039, 7079, 7119, 7159, 7199, 7239, 7279, 7319, 7359, 7399, 7439, 7479, 7519, 7559, 7599, 7639, 7679, 7719, 7759, 7799, 7839, 7879, 7919, 7959, 7999, 8039, 8079, 8119, 8159, 8199, 8239, 8279, 8319, 8359, 8399, 8439, 8479, 8519, 8559, 8599, 8639, 8679, 8719, 8759, 8799, 8839, 8879, 8919, 8959, 8999, 9039, 9079, 9119, 9159, 9199, 9239, 9279, 9319, 9359, 9399, 9439, 9479, 9519, 9559, 9599, 9639, 9679, 9719, 9759, 9799, 9839, 9879, 9919, 9959, 9999, 10039, 10079, 10119, 10159, 10199]


    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'  # Specify the Python version you need

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r cncf-youtube-channel-summarizer/requirements.txt

    - name: Run script for iteration
      run: |
          start=${{ matrix.index }}
          end=$((start + 39))
          echo "Running script with arguments: $start, $end"
          python cncf-youtube-channel-summarizer/transcript_summarizer_parallel.py $start $end

    - name: Upload Summaries
      uses: actions/upload-artifact@v4
      with:
          name: cncf_video_summary_${{ matrix.index }}_${{ matrix.index_plus_one }}.csv
          path: cncf-youtube-channel-summarizer/data/cncf_video_summary_${{ matrix.index}}.csv

    - name: Upload missed_video_id 
      uses: actions/upload-artifact@v4
      with:
          name: missed_video_id_${{ matrix.index }}_${{ matrix.index_plus_one }}.txt
          path: cncf-youtube-channel-summarizer/data/missed_video_id_${{ matrix.index}}.txt

    - name: Commit Change for "cncf_video_summary.csv"
      run: |
          git config --global user.name 'Yuhao Chen'
          git config --global user.email 'yuhao.chenyh@gmail.com'
          git pull origin main
          git add cncf-youtube-channel-summarizer/data/cncf_video_summary_${{matrix.index}}.csv || exit 0
          git commit -m "Add Summaries and Keywords" --signoff || exit 0
          git push


    - name: Commit Change for "missed_video_id.txt"
      run: |
          git config --global user.name 'Yuhao Chen'
          git config --global user.email 'yuhao.chenyh@gmail.com'
          git pull origin main
          git add cncf-youtube-channel-summarizer/data/missed_video_id_${{matrix.index}}.txt || exit 0
          git commit -m "Add missed_video_id" --signoff || exit 0
          git push
